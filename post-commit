#!/bin/bash

# Git hook to run local build and update script after commits to release branch
# This hook will run after every commit

# Get current branch name
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Define release branch patterns (you can modify these as needed)
release_branch_patterns=("main" "master" "release" "release/*" "prod" "production")

# Check if current branch matches any release branch pattern
is_release_branch=false
for pattern in "${release_branch_patterns[@]}"; do
    if [[ $current_branch == $pattern ]] || [[ $current_branch == ${pattern#/*/}/* ]]; then
        is_release_branch=true
        break
    fi
done

# Only run build if on a release branch
if [ "$is_release_branch" = true ]; then
    echo "Detected commit on release branch: $current_branch"
    echo "Running local build and update process..."
    
    # Change to the project directory (where the git worktree is located)
    PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"
    cd "$PROJECT_DIR"
    
    # Check if we're in the right directory
    if [ ! -f "./local-build.sh" ]; then
        echo "Error: local-build.sh script not found in current directory: $(pwd)"
        exit 1
    fi
    
    echo "Current directory: $(pwd)"
    
    # Run the local build script
    echo "Executing local build script..."
    ./local-build.sh
    
    # Run the update-latest script after successful build
    if [ -f "./scripts/update-latest.sh" ]; then
        echo "Executing update-latest script..."
        ./scripts/update-latest.sh
    else
        echo "Warning: update-latest.sh script not found"
    fi
else
    echo "Not on a release branch ($current_branch), skipping build"
fi